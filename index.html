<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transformer Monitor ‚Äî Giao di·ªán c≈© + JSON ESP (·∫©n ƒë·∫øn khi c√≥ g√≥i h·ª£p l·ªá)</title>
  <style>
    :root{
      --bg:#0b1220; --surface:#0e1424; --card:#0f1a2d; --text:#e6eefc; --muted:#9fb1c8;
      --primary:#22c55e; --accent:#38bdf8; --warn:#f59e0b; --danger:#ef4444; --ok:#34d399;
      --ring:rgba(255,255,255,.08); --border:rgba(255,255,255,.08); --shadow:0 16px 40px rgba(0,0,0,.35);
      --radius:18px; --gap:16px; --navW:88px; --cardPad:16px;
      --chip:#0b1a33; --chipBr:#112446; --chip2:#0d213e; --chip2Br:#133056;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}

    /* ===== Left compact sidebar ===== */
    .sidenav{position:fixed;left:0;top:0;bottom:0;width:var(--navW);background:#0a1326;border-right:1px solid var(--border);
      display:flex;flex-direction:column;align-items:center;gap:14px;padding:12px 10px}
    .dot{width:38px;height:38px;background:#0e1a34;border-radius:12px;border:1px solid var(--border)}

    /* ===== Topbar ===== */
    .topbar{position:sticky;top:0;left:var(--navW);right:0;background:linear-gradient(to bottom,rgba(11,18,32,.9),rgba(11,18,32,.7));
      -webkit-backdrop-filter: blur(8px);backdrop-filter: blur(8px);border-bottom:1px solid var(--border);z-index:8}
    .brand{display:flex;align-items:center;gap:12px;font-weight:700}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#34d399,#22d3ee)}
    .toolbar{display:flex;align-items:center;gap:8px}
    .wrap{padding:12px 16px;padding-left:calc(var(--navW) + 16px);}

    /* ===== Filters ===== */
    .filters{display:grid;grid-template-columns: 1.5fr 0.7fr 0.7fr 0.7fr auto;gap:12px;margin:12px 0}
    .i{background:#0f1d35;border:1px solid var(--border);border-radius:14px;padding:12px 14px;color:var(--text)}
    .btn{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#16a34a;color:white;cursor:pointer;font-weight:600}
    .btn.ghost{background:#0f1d35;color:var(--text)}

    /* ===== Grid ===== */
    .wrap-main{padding-left:calc(var(--navW) + 16px);padding-right:16px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:18px;margin:10px 0 32px}
    .empty{opacity:.7;border:1px dashed var(--border);border-radius:16px;padding:20px;text-align:center;margin:24px 0}

    /* ===== Card ===== */
    .card{background:var(--card);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);padding:var(--cardPad);position:relative}
    .card .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800}
    .pin{width:26px;height:26px;border-radius:10px;border:1px solid var(--border);background:#12213b;color:#ff62a2;display:flex;align-items:center;justify-content:center}
    .status{padding:2px 10px;border-radius:999px;font-size:13px;font-weight:700}
    .status.ok{background:rgba(52,211,153,.18);color:#bdf8e3;border:1px solid rgba(52,211,153,.5)}
    .status.busy{background:rgba(56,189,248,.15);color:#c8f1ff;border:1px solid rgba(56,189,248,.5)}
    .status.alert{background:rgba(245,158,11,.15);color:#ffe8b2;border:1px solid rgba(245,158,11,.5)}
    .status.error{background:rgba(239,68,68,.15);color:#ffd0d0;border:1px solid rgba(239,68,68,.5)}

    .sub{opacity:.8;margin-top:-2px}

    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0 6px}
    .chip{background:var(--chip);border:1px solid var(--chipBr);border-radius:12px;padding:10px}
    .cap{font-size:12px;color:var(--muted)}
    .val{font-weight:800;font-size:18px;margin-top:2px}

    .load{margin-top:8px;margin-bottom:8px}
    .bar{height:8px;background:#0b1a33;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#3b82f6,#22d3ee)}

    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{background:var(--chip2);border:1px solid var(--chip2Br);border-radius:999px;padding:6px 10px;font-size:13px;display:flex;align-items:center;gap:8px}

    .spark{height:68px;background:#0b1c34;border:1px dashed var(--chip2Br);border-radius:12px;margin:10px 0;position:relative}
    .spark>canvas{position:absolute;inset:0;width:100%;height:100%}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions .btn{background:#12213b;color:var(--text);border-color:var(--chip2Br)}

    dialog{width:1000px;max-width:calc(100vw - 32px);border:1px solid var(--border);border-radius:18px;background:var(--surface);color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .dgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    canvas.big{width:100%;height:200px;border:1px solid var(--border);background:#0d1b2e;border-radius:12px}
  </style>
</head>
<body>
  <aside class="sidenav">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </aside>

  <div class="topbar">
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:16px">
      <div class="brand"><div class="logo"></div><div>Transformer Monitor</div></div>
      <div class="toolbar">
        <button id="menuBtn" class="btn ghost">‚â°</button>
        <button id="themeBtn" class="btn ghost">üåô / üåû</button>
        <button id="addDemo" class="btn">Th√™m m√°y (demo)</button>
      </div>
    </div>
    <div class="wrap">
      <div class="filters">
        <input id="q" class="i" placeholder="T√¨m theo t√™n ho·∫∑c v·ªã tr√≠..." />
        <select id="status" class="i">
          <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="ok">OK</option>
          <option value="busy">BUSY</option>
          <option value="alert">ALERT</option>
          <option value="error">ERROR</option>
        </select>
        <select id="sort" class="i">
          <option value="name">T√™n</option>
          <option value="load">T·∫£i (%)</option>
          <option value="temp">Nhi·ªát m√°y</option>
          <option value="power">C√¥ng su·∫•t</option>
        </select>
        <select id="phase" class="i">
          <option value="all">T·∫•t c·∫£ pha</option>
          <option value="a">Pha A</option>
          <option value="b">Pha B</option>
          <option value="c">Pha C</option>
        </select>
        <button id="apply" class="btn" style="background:#22c55e">L·ªçc</button>
      </div>
    </div>
  </div>

  <main class="wrap-main">
    <div id="empty" class="empty">Ch∆∞a c√≥ thi·∫øt b·ªã online. H·ªá th·ªëng s·∫Ω t·ª± hi·ªÉn th·ªã khi nh·∫≠n g√≥i JSON ESP h·ª£p l·ªá (id 5 s·ªë + time + OTI/ATI/TTI + VL1..3 + IL1). B·∫°n c≈©ng c√≥ th·ªÉ b·∫•m "Th√™m m√°y (demo)" ƒë·ªÉ xem giao di·ªán m·∫´u.</div>
    <section id="grid" class="grid" style="display:none"></section>
  </main>

  <dialog id="details">
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <div id="dName" style="font-weight:800;font-size:20px"></div>
        <div id="dSub" class="sub"></div>
      </div>
      <button class="btn ghost" onclick="closeDetails()">ƒê√≥ng</button>
    </div>
    <div class="wrap">
      <div class="dgrid">
        <canvas id="cP" class="big"></canvas>
        <canvas id="cT" class="big"></canvas>
        <canvas id="cO" class="big"></canvas>
        <canvas id="cU" class="big"></canvas>
        <canvas id="cUP" class="big"></canvas>
        <canvas id="cF" class="big"></canvas>
      </div>
    </div>
  </dialog>

  <script>
    // ==================== CONFIG ====================
    const CONFIG = {
      LIVE_URL: 'http://localhost/ESP/live.php?id=TB12345',
      POLL_INTERVAL_MS: 1000,
      STALE_MS: 3000,
      POWER_INPUT_UNITS: 'W',   // 'W' n·∫øu P1..P3 l√† watt; 'kW' n·∫øu ƒë√£ l√† kW
      VOLTAGE_VALUES: 'PHASE',  // 'PHASE' n·∫øu VL1..VL3 l√† Upha; 'LINE' n·∫øu l√† ULL
    };

    // ==================== STATE ====================
    const DEMO_FLAG = Symbol('demo');
    const N_HISTORY = 60;
    let transformers = [];
    let LIVE_TIMER=null, TICK_TIMER=null, WATCHDOG_TIMER=null;

    // ==================== HELPERS ====================
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const rnd=(n=1)=>(Math.random()*2-1)*n; const round=(v,d=0)=>{const k=10**d;return Math.round(v*k)/k}; const round1=(v)=>round(v,1);
    function toNum(v){ if(typeof v==='number') return v; if(typeof v==='string'){const n=parseFloat(v.replace(',','.').trim()); return Number.isNaN(n)?undefined:n;} }
    function parseEspTime(s){ if(typeof s!=='string') return Date.now(); const m=s.match(/^(\d{2})-(\d{2})-(\d{2})\s+(\d{2})-(\d{2})-(\d{2})$/); if(!m) return Date.now(); return new Date(2000+ +m[3], +m[2]-1, +m[1], +m[4], +m[5], +m[6]).getTime(); }

    function makeTransformer(id,name,loc){
      const vll=420+Math.random()*20, vph=vll/Math.sqrt(3); const ia=120, ib=110, ic=115; const pf=0.9; const pkw=round((vll*Math.sqrt(3)*(ia+ib+ic)/3*pf)/1000,1);
      const oil=60, core=72, amb=35; const seed={p:[],t:[],o:[],v:[],va:[],vb:[],vc:[],fa:[],fb:[],fc:[]};
      for(let i=0;i<N_HISTORY;i++){seed.p.push(pkw+rnd(4)); seed.t.push(core+rnd(1.2)); seed.o.push(oil+rnd(0.8)); seed.v.push(vll+rnd(6)); seed.va.push(vph+rnd(3)); seed.vb.push(vph+rnd(3)); seed.vc.push(vph+rnd(3)); seed.fa.push(50+rnd(.08)); seed.fb.push(50+rnd(.08)); seed.fc.push(50+rnd(.08));}
      return {id,name,location:loc, voltage:{ab:vll,bc:vll,ca:vll,phase:{a:vph,b:vph,c:vph}}, current:{a:ia,b:ib,c:ic}, power:{kw:pkw,kva:round(pkw/pf,1),pf:pf}, temp:{ambient:amb, core:core, oil:oil}, freq:{a:50,b:50,c:50},
              vibration:1.2, load:round((pkw/750)*100), hist:seed, lastSeen:Date.now(), stale:false};
    }

    // ==================== ADAPTER & VALIDATION ====================
    function idIsFiveDigits(v){ if(v==null) return false; const s=String(v).trim(); return /^\d{5}$/.test(s); }
    function meetsMinimumLive(raw){
      return (
        idIsFiveDigits(raw.id ?? raw.ID) &&
        typeof raw.time === 'string' && /^(\d{2})-(\d{2})-(\d{2})\s+(\d{2})-(\d{2})-(\d{2})$/.test(raw.time) &&
        raw.OTI!==undefined && raw.ATI!==undefined && raw.TTI!==undefined &&
        raw.VL1!==undefined && raw.VL2!==undefined && raw.VL3!==undefined &&
        raw.IL1!==undefined // t·ªëi thi·ªÉu t·ªõi IL1 m·ªõi cho hi·ªÉn th·ªã
      );
    }

    function adaptEspJson(d){
      const out = { id: String(d.id ?? d.ID ?? '00000'), name: d.name ?? `MBA-${d.id ?? 'LIVE'}`, voltage:{phase:{}}, current:{}, power:{}, freq:{}, temp:{}, source_ts: parseEspTime(d.time) };
      const oti=toNum(d.OTI), ati=toNum(d.ATI), tti=toNum(d.TTI);
      if(oti!==undefined){ out.temp.oil=round1(oti); out.temp.core ??= round1(oti+3); }
      if(ati!==undefined) out.temp.ambient=round1(ati);
      if(tti!==undefined) out.humidity={ambient:round1(tti)};
      const va=toNum(d.VL1), vb=toNum(d.VL2), vc=toNum(d.VL3);
      if(va!==undefined) out.voltage.phase.a=va; if(vb!==undefined) out.voltage.phase.b=vb; if(vc!==undefined) out.voltage.phase.c=vc;
      if(CONFIG.VOLTAGE_VALUES==='PHASE'){
        const arr=[va,vb,vc].filter(n=>typeof n==='number'); if(arr.length){ const vph=arr.reduce((a,b)=>a+b,0)/arr.length; const vll=vph*Math.sqrt(3); out.voltage.ab=vll; out.voltage.bc=vll; out.voltage.ca=vll; }
      }else{ const arr=[va,vb,vc].filter(n=>typeof n==='number'); if(arr.length){ const vll=arr.reduce((a,b)=>a+b,0)/arr.length; out.voltage.ab=vll; out.voltage.bc=vll; out.voltage.ca=vll; const vph=vll/Math.sqrt(3); out.voltage.phase.a??=vph; out.voltage.phase.b??=vph; out.voltage.phase.c??=vph; } }
      const ia=toNum(d.IL1), ib=toNum(d.IL2), ic=toNum(d.IL3); if(ia!==undefined) out.current.a=ia; if(ib!==undefined) out.current.b=ib; if(ic!==undefined) out.current.c=ic;
      const p1=toNum(d.P1), p2=toNum(d.P2), p3=toNum(d.P3); if([p1,p2,p3].some(v=>v!==undefined)){ let sum=(p1||0)+(p2||0)+(p3||0); if(CONFIG.POWER_INPUT_UNITS==='W') sum/=1000; out.power.kw=round1(sum); out.power.pf ??= 0.9; out.power.kva=round1(out.power.kw/Math.max(0.1,out.power.pf)); }
      const f1=toNum(d.F1), f2=toNum(d.F2), f3=toNum(d.F3); if([f1,f2,f3].some(v=>v!==undefined)){ out.freq.a=f1??50; out.freq.b=f2??50; out.freq.c=f3??50; }
      const q1=toNum(d.Q1), q2=toNum(d.Q2), q3=toNum(d.Q3); if([q1,q2,q3].some(v=>v!==undefined)){ out.energy={phase:{a:q1,b:q2,c:q3}, total:(q1||0)+(q2||0)+(q3||0)} }
      const lp=toNum(d.LP); if(lp!==undefined) out.load=round(lp,1);
      return out;
    }

    // ==================== RENDER ====================
    const grid = document.getElementById('grid');
    const emptyEl = document.getElementById('empty');
    const selStatus = document.getElementById('status');
    const selSort = document.getElementById('sort');
    const selPhase = document.getElementById('phase');
    document.getElementById('apply').addEventListener('click', render);

    function statusClass(s){ if(s==='error') return 'status error'; if(s==='alert') return 'status alert'; if(s==='busy') return 'status busy'; return 'status ok'; }
    function computeStatus(m){ if(m.stale) return 'error'; if(m.temp.core>95 || m.temp.oil>95 || m.load>110) return 'alert'; if(m.temp.core>85 || m.temp.oil>85 || m.load>95) return 'busy'; return 'ok'; }
    function oneMetric(title,val,unit){ return `<div class="chip"><div class="cap">${title}</div><div class="val">${val ?? '-'} <small style="opacity:.6">${unit||''}</small></div></div>`; }

    function cardHTML(m){
      const st = computeStatus(m); m.status=st;
      const actionsDemo = m[DEMO_FLAG] ? `<button class="btn" style="background:#ef4444" data-act="removeDemo" data-id="${m.id}">X√≥a demo</button>` : '';
      return `<article class="card" data-id="${m.id}">
        <div class="top">
          <div class="title"><div class="pin">üìå</div><div>${m.name}</div></div>
          <div class="${statusClass(st)}">${st.toUpperCase()}</div>
        </div>
        <div class="sub">${m.location||''}</div>
        <div class="metrics">
          ${oneMetric('Uab (V)', round(m.voltage.ab))}
          ${oneMetric('Ubc (V)', round(m.voltage.bc))}
          ${oneMetric('Uca (V)', round(m.voltage.ca))}
          ${oneMetric('Ia (A)', round(m.current.a))}
          ${oneMetric('Ib (A)', round(m.current.b))}
          ${oneMetric('Ic (A)', round(m.current.c))}
          ${oneMetric('P (kW)', round1(m.power.kw))}
          ${oneMetric('S (kVA)', round1(m.power.kva))}
          ${oneMetric('PF', m.power.pf?.toFixed?.(1))}
        </div>
        <div class="load"><div style="display:flex;justify-content:space-between"><div>M·ª©c t·∫£i: ${m.load ?? '-'}%</div></div>
          <div class="bar"><span style="width:${clamp(m.load||0,0,150)}%"></span></div>
        </div>
        <div class="badges">
          <div class="badge">üå°Ô∏è M√¥i tr∆∞·ªùng: ${m.temp.ambient??'-'}¬∞C</div>
          <div class="badge">üî• M√°y: ${m.temp.core??'-'}¬∞C</div>
          <div class="badge">üõ¢Ô∏è D·∫ßu: ${m.temp.oil??'-'}¬∞C</div>
          <div class="badge">üìà ƒê·ªô rung: ${m.vibration??'-'} mm/s</div>
        </div>
        <div class="spark"><canvas id="spark-${m.id}"></canvas></div>
        <div class="actions">
          <button class="btn ghost" data-act="details" data-id="${m.id}">Chi ti·∫øt</button>
          <button class="btn ghost" data-act="freeze" data-id="${m.id}">ƒê√≥ng bƒÉng</button>
          ${actionsDemo}
        </div>
      </article>`;
    }

    function render(){
      const q = document.getElementById('q').value.trim().toLowerCase();
      const st = selStatus.value; const sort = selSort.value; const phase = selPhase.value;
      let arr = transformers.slice();
      if(q) arr = arr.filter(m=> String(m.id).toLowerCase().includes(q) || (m.name||'').toLowerCase().includes(q) || (m.location||'').toLowerCase().includes(q));
      if(st!=='all') arr = arr.filter(m=>m.status===st);
      if(sort==='name') arr.sort((a,b)=> String(a.name).localeCompare(String(b.name)));
      if(sort==='load') arr.sort((a,b)=> (b.load||0) - (a.load||0));
      if(sort==='temp') arr.sort((a,b)=> (b.temp.core||0) - (a.temp.core||0));
      if(sort==='power') arr.sort((a,b)=> (b.power.kw||0) - (a.power.kw||0));

      if(arr.length===0){ emptyEl.style.display='block'; grid.style.display='none'; grid.innerHTML=''; return; }
      emptyEl.style.display='none'; grid.style.display='grid';
      grid.innerHTML = arr.map(cardHTML).join('');
      grid.querySelectorAll('[data-act]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-act');
          if(act==='details') openDetails(String(id));
          if(act==='freeze') toggleFreeze(String(id));
          if(act==='removeDemo') removeDemo(String(id));
        });
      });
      arr.forEach(m=> drawSpark('spark-'+m.id, (m.hist&&m.hist.p)||[]));
    }

    function drawSpark(id,data){ const c=document.getElementById(id); if(!c) return; const ctx=c.getContext('2d'); const W=c.width=c.clientWidth; const H=c.height=c.clientHeight; ctx.clearRect(0,0,W,H); ctx.strokeStyle='rgba(255,255,255,.1)'; ctx.strokeRect(8,8,W-16,H-16); if(!data.length) return; const min=Math.min(...data), max=Math.max(...data), span=Math.max(1,max-min); ctx.beginPath(); data.forEach((v,i)=>{ const x=10+i*((W-20)/(data.length-1)); const y=H-10-((v-min)/span)*(H-20); i?ctx.lineTo(x,y):ctx.moveTo(x,y);}); ctx.strokeStyle='#22d3ee'; ctx.lineWidth=2; ctx.stroke(); }

    // ==================== DETAILS ====================
    const dlg = document.getElementById('details'); let currentDetailsId=null; function closeDetails(){ dlg.close(); currentDetailsId=null; } window.closeDetails=closeDetails;
    function openDetails(id){ currentDetailsId=id; refreshDetails(); dlg.showModal(); }
    function refreshDetails(){ if(!currentDetailsId) return; const m = transformers.find(t=>String(t.id)===String(currentDetailsId)); if(!m) return;
      document.getElementById('dName').textContent=m.name+ ' ‚Äî ' + (m.status||'OK').toUpperCase();
      document.getElementById('dSub').textContent = `ID: ${m.id} ‚Ä¢ TS: ${m.source_ts? new Date(m.source_ts).toLocaleString(): '‚Äî'}`;
      const h=m.hist||{p:[],t:[],o:[],v:[],va:[],vb:[],vc:[],fa:[],fb:[],fc:[]}; drawBig('cP',h.p,'C√¥ng su·∫•t (kW)'); drawBig('cT',h.t,'Nhi·ªát m√°y (¬∞C)'); drawBig('cO',h.o,'Nhi·ªát d·∫ßu (¬∞C)'); drawBig('cU',h.v,'U d√¢y-d√¢y (V)'); drawMulti('cUP',[h.va,h.vb,h.vc],['Va','Vb','Vc'],'U pha (V)'); drawMulti('cF',[h.fa,h.fb,h.fc],['Fa','Fb','Fc'],'T·∫ßn s·ªë (Hz)');
    }
    function drawBig(id,data,title){ const c=document.getElementById(id), ctx=c.getContext('2d'); const W=c.width=c.clientWidth, H=c.height=c.clientHeight; ctx.clearRect(0,0,W,H); ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.strokeRect(34,10,W-44,H-34); if(!data.length) return; const min=Math.min(...data), max=Math.max(...data), span=Math.max(1,max-min); ctx.beginPath(); data.forEach((v,i)=>{ const x=34+i*((W-44)/(data.length-1)); const y=H-24-((v-min)/span)*(H-44); i?ctx.lineTo(x,y):ctx.moveTo(x,y);}); ctx.lineWidth=2; ctx.strokeStyle='#22d3ee'; ctx.stroke(); ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='12px system-ui'; ctx.fillText(title, 40, 22); }
    function drawMulti(id,series,labels,title){ const c=document.getElementById(id), ctx=c.getContext('2d'); const W=c.width=c.clientWidth, H=c.height=c.clientHeight; ctx.clearRect(0,0,W,H); ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.strokeRect(34,10,W-44,H-34); const all=series.flat(); if(!all.length) return; const min=Math.min(...all), max=Math.max(...all), span=Math.max(1,max-min); const cols=['#60a5fa','#34d399','#fbbf24']; series.forEach((data,si)=>{ if(!data.length) return; ctx.beginPath(); data.forEach((v,i)=>{ const x=34+i*((W-44)/(data.length-1)); const y=H-24-((v-min)/span)*(H-44); i?ctx.lineTo(x,y):ctx.moveTo(x,y);}); ctx.lineWidth=2; ctx.strokeStyle=cols[si%cols.length]; ctx.stroke(); }); ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='12px system-ui'; ctx.fillText(title, 40, 22); }

    // ==================== TICK + WATCHDOG ====================
    const frozen = new Set(); function toggleFreeze(id){ id=String(id); if(frozen.has(id)) frozen.delete(id); else frozen.add(id); }
    function tick(){ transformers.forEach(m=>{ if(!m[DEMO_FLAG]) return; if(frozen.has(String(m.id))) return; m.power.kw=clamp(round1(m.power.kw+(Math.random()-.5)*2),0,750); m.temp.core=clamp(round1(m.temp.core+(Math.random()-.5)*0.8),20,120); m.temp.oil=clamp(round1(m.temp.oil+(Math.random()-.5)*0.6),20,120); m.voltage.ab=clamp(round(m.voltage.ab+(Math.random()-.5)*5),300,480); const vph=m.voltage.ab/Math.sqrt(3); m.voltage.phase.a=clamp(round(vph+(Math.random()-.5)*3),170,280); m.voltage.phase.b=clamp(round(vph+(Math.random()-.5)*3),170,280); m.voltage.phase.c=clamp(round(vph+(Math.random()-.5)*3),170,280); m.freq.a=round1(50+(Math.random()-.5)*0.3); m.freq.b=round1(50+(Math.random()-.5)*0.3); m.freq.c=round1(50+(Math.random()-.5)*0.3); m.load=clamp(round((m.power.kw/750)*100),0,150); m.lastSeen=Date.now(); pushHistory(m); }); render(); }
    function pushHistory(m){ const vavg=(m.voltage.ab+m.voltage.bc+m.voltage.ca)/3; if(!m.hist) m.hist={p:[],t:[],o:[],v:[],va:[],vb:[],vc:[],fa:[],fb:[],fc:[]}; const h=m.hist; [['p',m.power.kw],['t',m.temp.core],['o',m.temp.oil],['v',vavg],['va',m.voltage.phase.a],['vb',m.voltage.phase.b],['vc',m.voltage.phase.c],['fa',m.freq.a],['fb',m.freq.b],['fc',m.freq.c]].forEach(([k,val])=>{ h[k].push(val); if(h[k].length>N_HISTORY) h[k].shift(); }); }
    function watchdog(){ const now=Date.now(); transformers.forEach(m=>{ if(m[DEMO_FLAG]) return; if(now-m.lastSeen>CONFIG.STALE_MS){ m.stale=true; m.status='error'; }}); render(); }
    function removeDemo(id){ transformers = transformers.filter(x=>String(x.id)!==String(id)); render(); }

    // ==================== DATA FLOW ====================
    function applyIncomingPayload(payload){ const arr=Array.isArray(payload)?payload:[payload]; const now=Date.now(); arr.forEach(raw=>{
        const looksESP = raw && ('OTI'in raw || 'VL1'in raw || 'IL1'in raw || 'P1'in raw || 'F1'in raw || 'Q1'in raw || 'LP'in raw || 'time'in raw);
        if(!looksESP){ return; }
        const keyRaw = String(raw.id ?? raw.ID ?? '');
        let m = transformers.find(x=>String(x.id)===keyRaw);
        // T·∫°o M·ªöI ch·ªâ khi g√≥i ƒë·∫°t t·ªëi thi·ªÉu & id ƒë·ªß 5 s·ªë
        if(!m){ if(!meetsMinimumLive(raw)) return; const d0=adaptEspJson(raw); m = makeTransformer(d0.id, d0.name||`MBA-${d0.id}`, d0.location||'-'); m[DEMO_FLAG]=false; transformers.push(m); }
        // Merge t·ª´ g√≥i hi·ªán t·∫°i (k·ªÉ c·∫£ ch∆∞a ƒë·ªß t·ªëi thi·ªÉu, n·∫øu m ƒë√£ t·ªìn t·∫°i)
        const d = adaptEspJson(raw);
        if(typeof d.name==='string') m.name=d.name; if(typeof d.location==='string') m.location=d.location;
        if(d.voltage){ if(typeof d.voltage.ab==='number') m.voltage.ab=d.voltage.ab; if(typeof d.voltage.bc==='number') m.voltage.bc=d.voltage.bc; if(typeof d.voltage.ca==='number') m.voltage.ca=d.voltage.ca; if(d.voltage.phase){ if(typeof d.voltage.phase.a==='number') m.voltage.phase.a=d.voltage.phase.a; if(typeof d.voltage.phase.b==='number') m.voltage.phase.b=d.voltage.phase.b; if(typeof d.voltage.phase.c==='number') m.voltage.phase.c=d.voltage.phase.c; } }
        if(d.current){ ['a','b','c'].forEach(k=>{ if(typeof d.current[k]==='number') m.current[k]=d.current[k]; }); }
        if(d.power){ if(typeof d.power.kw==='number') m.power.kw=d.power.kw; if(typeof d.power.pf==='number') m.power.pf=d.power.pf; m.power.kva=round1(m.power.kw/Math.max(0.1,m.power.pf||0.9)); }
        if(d.temp){ ['ambient','core','oil'].forEach(k=>{ if(typeof d.temp[k]==='number') m.temp[k]=d.temp[k]; }); }
        if(d.freq){ ['a','b','c'].forEach(k=>{ if(typeof d.freq[k]==='number') m.freq[k]=d.freq[k]; }); }
        if(typeof d.vibration==='number') m.vibration=d.vibration;
        if(typeof d.load==='number') m.load=d.load;
        if(d.humidity) m.humidity=d.humidity;
        if(d.status) m.status=String(d.status).toLowerCase();
        m.source_ts = d.source_ts || m.source_ts; m.lastSeen=now; m.stale=false; pushHistory(m);
      }); render(); }

    function startLiveREST(url, intervalMs){ if(LIVE_TIMER) clearInterval(LIVE_TIMER); LIVE_TIMER=setInterval(async()=>{ try{ const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); const payload=await res.json(); applyIncomingPayload(payload); }catch(e){/* im l·∫∑ng */} }, intervalMs); }

    // ==================== BOOT ====================
    document.getElementById('themeBtn').addEventListener('click', ()=>{ const r=document.documentElement; const dark=getComputedStyle(r).getPropertyValue('--bg').trim()==='#0b1220'; if(dark){ r.style.setProperty('--bg','#f5f7fb'); r.style.setProperty('--surface','#ffffff'); r.style.setProperty('--card','#ffffff'); r.style.setProperty('--text','#0b1220'); r.style.setProperty('--muted','#334155'); r.style.setProperty('--border','rgba(0,0,0,.08)'); } else { r.style.setProperty('--bg','#0b1220'); r.style.setProperty('--surface','#0e1424'); r.style.setProperty('--card','#0f1a2d'); r.style.setProperty('--text','#e6eefc'); r.style.setProperty('--muted','#9fb1c8'); r.style.setProperty('--border','rgba(255,255,255,.08)'); } render(); });
    document.getElementById('addDemo').addEventListener('click',()=>{ const id='DEMO-'+Math.floor(Math.random()*1000); const demo=makeTransformer(id,'MBA-'+id,'Khu m·ªõi #'+(Math.floor(Math.random()*10)+1)); demo[DEMO_FLAG]=true; transformers.push(demo); render(); });

    // KH√îNG seed demo ban ƒë·∫ßu -> trang tr·ªëng t·ªõi khi c√≥ g√≥i h·ª£p l·ªá ho·∫∑c ng∆∞·ªùi d√πng b·∫•m Th√™m m√°y (demo)
    render();
    TICK_TIMER=setInterval(tick,1000);
    WATCHDOG_TIMER=setInterval(watchdog,500);
    startLiveREST(CONFIG.LIVE_URL, CONFIG.POLL_INTERVAL_MS);
  </script>
</body>
</html>
