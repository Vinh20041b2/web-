const broker = "wss://e8fa3a03f84a4ba6ae0a38cb4c21a9e6.s1.eu.hivemq.cloud:8884/mqtt"; // URL TLS WebSocket
const topic = "esp/cambien"; 
const clientId = "webClient_" + Math.random().toString(16).substr(2, 8);

const username = "vuvuvu";  
const password = "1234567890Aa";  // Cập nhật đúng mật khẩu

const client = mqtt.connect(broker, {
    clientId: clientId,
    username: username,
    password: password,
    clean: true,
    connectTimeout: 4000,
    reconnectPeriod: 1000
});

client.on("connect", () => {
    console.log("🟢 Kết nối MQTT thành công!");
    client.subscribe(topic, (err) => {
        if (!err) {
            console.log(`✅ Đã đăng ký topic: ${topic}`);
        } else {
            console.log("❌ Lỗi khi đăng ký topic!", err);
        }
    });
});

client.on("message", (topic, message) => {
    try {
        let data = JSON.parse(message.toString());
        console.log("📩 Dữ liệu nhận:", data);

        document.getElementById("humidity").innerText = data.sensor_doam + " %";
        document.getElementById("light").innerText = data.sensor_anhsang + " lux";
        document.getElementById("temperature").innerText = data.sensor_nhietdo + " °C";
        document.getElementById("soil-moisture").innerText = data.sensor_doamdat + " %";
    } catch (error) {
        console.error("❌ Lỗi xử lý JSON:", error);
    }
});

client.on("error", (err) => {
    console.error("🔴 Lỗi MQTT:", err);
});
